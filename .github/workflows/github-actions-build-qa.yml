# Github actions Build and QA pipeline
# This was autogenerated from Azure Pipelines YAML with https://pipelinestoactions.azurewebsites.net/

name: Build and test

on:
  pull_request:
    branches:
      - master
      - stage
  push:
    branches:
      - master
      - stage
  workflow_dispatch:

env:
  phpVersion: '8.1'
  nodeVersion: '16.13.1'
  rootFolder: ${{ github.workspace }}
  pluginFolder: $rootFolder/wp-content/plugins/ewplugin
  themeFolder: $rootFolder/wp-content/themes/ew-theme

jobs:

  build-and-test:
    name: Build and test

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set PHP version to $phpVersion
        run: |
          sudo update-alternatives --set php /usr/bin/php$phpVersion
          sudo update-alternatives --set phar /usr/bin/phar$phpVersion
          sudo update-alternatives --set phpdbg /usr/bin/phpdbg$phpVersion
          sudo update-alternatives --set php-cgi /usr/bin/php-cgi$phpVersion
          sudo update-alternatives --set phar.phar /usr/bin/phar.phar$phpVersion
          php -version
        shell: bash

      - name: Set Node version to $nodeVersion
        uses: actions/setup-node@v3
        with:
          node-version: $nodeVersion
          cache: 'yarn'

      - name: Install composer packages in plugin
        run: composer install --no-interaction --prefer-dist
        shell: bash

      - name: Install composer packages in theme
        run: composer install --no-interaction --prefer-dist
        shell: bash

      - name: Install yarn packages in theme
        run: yarn install
        shell: bash

      - name: Build theme assets
        run: yarn build
        shell: bash

      - name: Install PHP testing environment
        run: |
          # Run MySQL server
          sudo systemctl start mysql.service

          # Download empty Wordpress installation and setup testing database
          bash bin/install-wp-tests.sh wp_wp-starter-test root root localhost latest
          
          # Add permissions to this folder so that tests can create their files
          sudo chmod 777 -R ./tests/tmp
        shell: bash

      - name: Run plugin PHP tests
        run: sudo php ./vendor/bin/phpunit --log-junit test-php-results.xml
        shell: bash
